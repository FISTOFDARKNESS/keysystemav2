<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Key Panel</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{background:#06060b;color:#dff9ff;font-family:Inter,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:28px;border-radius:12px;box-shadow:0 8px 40px rgba(0,200,255,0.06);width:420px;text-align:center}
h1{color:#00d4ff;margin:0 0 8px;font-size:20px}
.key{font-family:Consolas,monospace;font-size:18px;padding:12px;background:#071019;border-radius:8px;margin:12px 0;color:#bff6ff}
button{background:#00d4ff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;color:#001;font-weight:700}
button.secondary{background:#7c34ff;color:#fff;margin-left:8px}
small{color:#9fb6c9;display:block;margin-top:8px}
.row{display:flex;justify-content:center;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="card">
  <h1>Painel Key (Neon)</h1>
  <div id="key" class="key">Carregando...</div>
  <div class="row">
    <button id="refresh">Atualizar</button>
    <button id="regen" class="secondary">Forçar nova key</button>
  </div>
  <small id="info"></small>
</div>
<script>
const SITE_URL = window.location.origin; // assume site hospedado no mesmo domínio (Netlify)
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${value}; path=/; expires=${d.toUTCString()}; SameSite=Lax`;
}
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? m[2] : null;
}

async function loadKey() {
  document.getElementById('info').textContent = '';
  try {
    const res = await fetch(`${SITE_URL}/.netlify/functions/get-or-create-key`, { credentials: 'include' });
    if (!res.ok) {
      const txt = await res.text();
      document.getElementById('key').textContent = 'Sem key ativa';
      console.error('get-or-create-key failed', res.status, txt);
      return;
    }
    const j = await res.json();
    if (j.visitor_id) setCookie('visitor_id', j.visitor_id, 365);
    document.getElementById('key').textContent = j.key;
    document.getElementById('info').textContent = 'Expira em: ' + new Date(j.expires_at).toLocaleString();
  } catch (e) {
    document.getElementById('key').textContent = 'Erro ao carregar key';
    console.error(e);
  }
}

document.getElementById('refresh').addEventListener('click', loadKey);
document.getElementById('regen').addEventListener('click', async () => {
  const visitorId = getCookie('visitor_id');
  if (!visitorId) return alert('Visitor ID não encontrado; atualize a página primeiro.');
  try {
    const res = await fetch(`${SITE_URL}/.netlify/functions/regen-key`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-secret': '1234' },
      body: JSON.stringify({ visitor_id: visitorId })
    });
    const j = await res.json();
    if (!j.success) return alert('Falha: ' + j.message);
    document.getElementById('key').textContent = j.key;
    document.getElementById('info').textContent = 'Expira em: ' + new Date(j.expires_at).toLocaleString();
  } catch (e) {
    alert('Erro ao forçar nova key');
    console.error(e);
  }
});

loadKey();
</script>
</body>
</html>
